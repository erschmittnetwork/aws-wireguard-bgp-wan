name: Deploy static resources to S3

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install build dependencies (Pandoc, LaTeX)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            lmodern \
            fonts-dejavu \
            fonts-liberation \
            fonts-noto

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Build site artifacts into dist/
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist/docs dist/diagrams dist/assets

          # Copy homepage
          if [ -f index.html ]; then
            cp index.html dist/index.html
          fi

          # Render Mermaid diagrams
          - name: Render Mermaid diagrams (Docker)
          run: |
            mkdir -p dist/diagrams
            for f in diagrams/*.mmd; do
              base="$(basename "$f" .mmd)"
              docker run --rm \
                -v "$PWD:/data" \
                minlag/mermaid-cli \
                -i "/data/$f" \
                -o "/data/dist/diagrams/${base}.png" \
                -t default \
                -b transparent
          done

          # Copy assets
          if [ -d assets ]; then
            cp -R assets/* dist/assets/ || true
          fi

          # Build HTML
          pandoc docs/aws-wireguard-bgp-wan.tex \
            -s \
            --metadata title="AWS WireGuard BGP WAN with Automated HA Hub Failover" \
            -o dist/docs/aws-wireguard-bgp-wan.html

          # Build PDF
          pandoc docs/aws-wireguard-bgp-wan.tex \
            -s \
            --pdf-engine=pdflatex \
            -o dist/docs/aws-wireguard-bgp-wan.pdf

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::948544151710:role/GitHubActionsDeployRole
          aws-region: us-east-1

      - name: Sync site to S3
        run: aws s3 sync dist/ s3://network-blog-assets --delete

      - name: Invalidate CloudFront cache
        run: aws cloudfront create-invalidation --distribution-id E2K6CM81Z0U5LV --paths "/*"
