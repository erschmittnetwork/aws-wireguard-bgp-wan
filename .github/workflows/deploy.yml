name: Deploy static resources to S3

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies (Pandoc, LaTeX)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            lmodern \

      - name: Build site artifacts into dist/
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist
          mkdir -p dist/docs dist/diagrams dist/assets

          # Copy homepage
          if [ -f index.html ]; then
            cp index.html dist/index.html
          fi

          # Render Mermaid diagrams
          if compgen -G "diagrams/*.mmd" > /dev/null; then
            for f in diagrams/*.mmd; do
              base="$(basename "$f" .mmd)"
              docker run --rm \
                -v "$PWD:/data" \
                minlag/mermaid-cli \
                -i "/data/$f" \
                -o "/data/dist/diagrams/${base}.png" \
                -t default \
                -b transparent \
                -w 2400 \
                -H 1400
            done
          else
            echo "No Mermaid diagrams found."
          fi

          # Copy assets
          if [ -d assets ]; then
            cp -R assets/* dist/assets/ || true
          fi

          cp -R dist/diagrams docs/ || true

          # Build HTML
          pandoc docs/aws-wireguard-bgp-wan.tex \
            -s \
            --resource-path=.:dist \
            -M title="AWS WireGuard BGP WAN with Automated HA Hub Failover" \
            -M date="$(date +%Y-%m-%d)" \
            -o dist/docs/aws-wireguard-bgp-wan.html

          # Build PDF
          pandoc docs/aws-wireguard-bgp-wan.tex \
            -s \
            --resource-path=.:dist \
            -M title="AWS WireGuard BGP WAN with Automated HA Hub Failover" \
            -M date="$(date +%Y-%m-%d)" \
            --pdf-engine=pdflatex \
            -o dist/docs/aws-wireguard-bgp-wan.pdf

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::948544151710:role/GitHubActionsDeployRole
          aws-region: us-east-1

      - name: Sync site to S3
        run: aws s3 sync dist/ s3://network-blog-assets --delete

      - name: Invalidate CloudFront cache
        run: aws cloudfront create-invalidation --distribution-id E2K6CM81Z0U5LV --paths "/*"
